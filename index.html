<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        .hidden { display: none !important; }
        /* Custom scrollbar for better dark mode look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .kanban-card, .crm-card { cursor: grab; }
        .kanban-card:active, .crm-card:active { cursor: grabbing; }
        .sidebar-text { transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-slate-200">

    <!-- =========== LOGIN PAGE =========== -->
    <div id="login-page" class="flex h-screen w-full items-center justify-center bg-gray-900">
        <div class="w-full max-w-sm rounded-xl bg-gray-800 p-8 shadow-2xl border border-gray-700">
            <div class="mb-6 text-center">
                <div id="login-icon-container" class="mx-auto h-12 w-12 text-blue-500"></div>
                <h1 class="mt-4 text-2xl font-bold text-white">Agency Platform</h1>
                <p class="text-slate-400">Đăng nhập để quản lý dự án & khách hàng</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="text-sm font-medium text-slate-300">Email</label>
                    <input id="username" type="email" placeholder="Vd: admin@gmail.com" class="mt-2 w-full rounded-lg border-2 border-gray-600 bg-gray-700 px-4 py-2 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-300">Mật khẩu</label>
                    <input id="password" type="password" placeholder="Mật khẩu của bạn" class="mt-2 w-full rounded-lg border-2 border-gray-600 bg-gray-700 px-4 py-2 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <p id="login-error" class="text-sm text-red-500 hidden"></p>
                <button type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-3 text-lg font-semibold text-white transition-colors hover:bg-blue-700 flex items-center justify-center">
                    <span id="login-button-text">Đăng nhập</span>
                    <svg id="login-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- =========== MAIN DASHBOARD =========== -->
    <main id="dashboard-page" class="hidden h-screen w-full font-sans text-slate-200">
        <div id="loading-overlay" class="absolute inset-0 bg-gray-900/80 z-50 flex flex-col items-center justify-center hidden">
             <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-white">Đang tải dữ liệu...</p>
        </div>
        <div class="flex h-full">
            <!-- Sidebar Navigation -->
            <nav id="sidebar" class="flex flex-col justify-between border-r border-gray-800 bg-gray-900 transition-all duration-300">
                <div>
                    <div class="flex h-16 items-center justify-between border-b border-gray-800 px-4">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <svg class="h-8 w-8 flex-shrink-0 text-blue-500" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 3H10V5H5V3ZM14 3H19V5H14V3ZM10 19H5V21H10V19ZM19 19H14V21H19V19ZM3 5V10H5V5H3ZM3 14V19H5V14H3ZM21 10V5H19V10H21ZM21 19V14H19V19H21ZM12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7Z"/></svg>
                            <span class="sidebar-text text-xl font-bold text-white whitespace-nowrap">Agency</span>
                        </div>
                         <button id="sidebar-toggle-desktop" class="rounded-md p-1 text-slate-400 hover:bg-gray-700 hidden lg:block">
                            <i data-lucide="chevrons-left" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <ul id="nav-list" class="flex flex-col gap-2 p-4">
                        <!-- Nav items will be injected here by JS -->
                    </ul>
                </div>
                <div class="border-t border-gray-800 p-4">
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white flex-shrink-0" id="user-avatar"></div>
                        <div class="overflow-hidden">
                             <p id="user-name" class="sidebar-text text-sm font-semibold text-white whitespace-nowrap"></p>
                             <p id="user-role" class="sidebar-text text-xs text-slate-400 whitespace-nowrap"></p>
                        </div>
                    </div>
                    <button id="logout-button" class="mt-4 flex w-full items-center gap-3 rounded-lg p-3 text-left text-sm font-medium transition-colors text-slate-400 hover:bg-gray-800 hover:text-white">
                        <i data-lucide="log-out" class="h-5 w-5 flex-shrink-0"></i>
                        <span class="sidebar-text">Đăng xuất</span>
                    </button>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                 <header class="flex h-16 items-center justify-between border-b border-gray-800 bg-gray-900/50 px-6">
                    <button id="sidebar-toggle-mobile" class="rounded-md p-1 text-slate-400 hover:bg-gray-700 lg:hidden">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                    <div id="page-title-header" class="text-lg font-semibold text-white"></div>
                     <div class="w-8"></div> <!-- Spacer -->
                </header>
                <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-950/30">
                    <!-- Content for pages will be injected here -->
                </main>
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        //=========== BASE DATA ===========//
        let allUsers = []; // All user info from API
        let crmData = [], projectsData = [], documentsData = [], tasksData = [], leadsData = [], logsData = [];

        //=========== APP STATE ===========//
        let currentUser = null;
        let activePage = 'chatbot';
        let draggedTaskId = null;
        let currentProjectView = null;
        let chatbotThreadId = null; // ID cho memory của chatbot
        let isSidebarCollapsed = window.innerWidth < 1024;

        //=========== DOM ELEMENTS ===========//
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const loginButtonText = document.getElementById('login-button-text');
        const loginSpinner = document.getElementById('login-spinner');
        const mainContent = document.getElementById('main-content');
        const navList = document.getElementById('nav-list');
        const userNameDisplay = document.getElementById('user-name');
        const userRoleDisplay = document.getElementById('user-role');
        const userAvatar = document.getElementById('user-avatar');
        const logoutButton = document.getElementById('logout-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleDesktop = document.getElementById('sidebar-toggle-desktop');
        const sidebarToggleMobile = document.getElementById('sidebar-toggle-mobile');
        const pageTitleHeader = document.getElementById('page-title-header');

        //=========== API & DATA FUNCTIONS ===========//
        const baserowHost = 'https://aibm.store/';
        const databaseToken = 'qg8JrpcRdnihf1VOZhHVo7Qyg8KlT87U';

        const fetchBaserowTable = async (tableId) => {
            const apiUrl = `${baserowHost}api/database/rows/table/${tableId}/?user_field_names=true`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'Authorization': `Token ${databaseToken}` }
                });
                if (!response.ok) throw new Error(`Failed to fetch table ${tableId}`);
                const data = await response.json();
                return data.results;
            } catch (error) {
                console.error(`Error fetching table ${tableId}:`, error);
                loginError.textContent = `Lỗi tải dữ liệu từ bảng ${tableId}. Vui lòng kiểm tra lại API.`;
                loginError.classList.remove('hidden');
                return []; // Return empty array on error
            }
        };

        const loadDashboardData = async () => {
            loadingOverlay.classList.remove('hidden');
            try {
                const [crm, projects, documents, tasks, leads, logs] = await Promise.all([
                    fetchBaserowTable(850), // crm
                    fetchBaserowTable(851), // project
                    fetchBaserowTable(855), // document
                    fetchBaserowTable(859), // task
                    fetchBaserowTable(853), // lead
                    fetchBaserowTable(857)  // logs
                ]);
                crmData = crm;
                projectsData = projects;
                documentsData = documents;
                tasksData = tasks;
                leadsData = leads;
                logsData = logs;
                renderPage(); // Initial page render after data is loaded
            } catch (error) {
                console.error("Failed to load initial dashboard data", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        };

        //=========== UI FUNCTIONS ===========//
        const applySidebarState = () => {
            if (isSidebarCollapsed) {
                sidebar.classList.add('w-20');
                sidebar.classList.remove('w-64');
                document.querySelectorAll('.sidebar-text').forEach(el => el.classList.add('hidden'));
                sidebarToggleDesktop.innerHTML = '<i data-lucide="chevrons-right" class="h-5 w-5"></i>';
            } else {
                sidebar.classList.add('w-64');
                sidebar.classList.remove('w-20');
                document.querySelectorAll('.sidebar-text').forEach(el => el.classList.remove('hidden'));
                sidebarToggleDesktop.innerHTML = '<i data-lucide="chevrons-left" class="h-5 w-5"></i>';
            }
            if (window.innerWidth < 1024) {
                 sidebar.classList.add('-translate-x-full', 'absolute', 'h-full', 'z-20');
            } else {
                 sidebar.classList.remove('-translate-x-full', 'absolute', 'h-full', 'z-20');
            }
            lucide.createIcons();
        };
        
        const toggleSidebar = () => {
             if (window.innerWidth < 1024) {
                sidebar.classList.toggle('-translate-x-full');
            } else {
                isSidebarCollapsed = !isSidebarCollapsed;
                applySidebarState();
            }
        };

        //=========== RENDER FUNCTIONS ===========//
        const getPageHeaderHTML = (title, subtitle) => `
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-white relative pb-2">${title}</h1>
                <p class="text-slate-400 mt-1">${subtitle}</p>
            </div>`;

        const renderPage = () => {
            mainContent.innerHTML = '';
            let pageTitle = '';
            const navItem = navItems.find(item => item.id === activePage);
            if (navItem) pageTitle = navItem.label;

            if (currentProjectView) {
                mainContent.innerHTML = getProjectDetailHTML(currentProjectView);
                renderProjectDetailTabs(currentProjectView, 'documents');
                addProjectDetailEventListeners(currentProjectView);
                pageTitle = `Dự án: ${currentProjectView.client && currentProjectView.client.length > 0 ? currentProjectView.client[0].value : 'Không tên'}`;
            } else {
                 switch(activePage) {
                    case 'chatbot': mainContent.innerHTML = getChatbotHTML(); addChatbotEventListeners(); break;
                    case 'tasks': mainContent.innerHTML = getKanbanHTML(); renderKanbanTasks(); addKanbanEventListeners(); break;
                    case 'crm': mainContent.innerHTML = getCrmHTML(); renderCrmDeals(); break;
                    case 'projects': mainContent.innerHTML = getProjectsHTML(); renderProjectFolders(); break;
                    case 'leads': mainContent.innerHTML = getLeadsHTML(); renderLeadsByProject(); break;
                }
            }
            pageTitleHeader.textContent = pageTitle;
            updateNav();
            lucide.createIcons();
        };

        const navItems = [
            { id: 'chatbot', label: 'Chatbot AI', icon: 'bot' },
            { id: 'tasks', label: 'Công việc', icon: 'check-square' },
            { id: 'crm', label: 'CRM', icon: 'users' },
            { id: 'projects', label: 'Project Drive', icon: 'folder-kanban' },
            { id: 'leads', label: 'Leads', icon: 'filter' },
        ];

        const updateNav = () => {
            navList.innerHTML = '';
            navItems.forEach(item => {
                const isActive = activePage === item.id;
                const buttonClasses = `flex w-full items-center gap-3 rounded-lg p-3 text-left text-sm font-medium transition-colors ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-gray-700 hover:text-white'}`;
                const li = document.createElement('li');
                li.innerHTML = `
                    <button data-page="${item.id}" class="${buttonClasses}">
                        <i data-lucide="${item.icon}" class="inline-block h-5 w-5 flex-shrink-0"></i>
                        <span class="sidebar-text">${item.label}</span>
                    </button>
                `;
                navList.appendChild(li);
            });
            document.querySelectorAll('#nav-list button').forEach(button => {
                button.addEventListener('click', (e) => {
                    activePage = e.currentTarget.dataset.page;
                    currentProjectView = null;
                    renderPage();
                    if(window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
                });
            });
            applySidebarState();
        };
        
        const getChatbotHTML = () => `<div>${getPageHeaderHTML('Chatbot AI', 'Trợ lý ảo giúp bạn truy xuất thông tin, tạo task, theo dõi dự án.')}<div class="flex flex-col bg-gray-800/50 rounded-lg" style="height: calc(100vh - 200px);"><div id="chatbot-messages" class="flex-1 space-y-4 overflow-y-auto p-4"><div class="flex items-end gap-2 justify-start"><div class="h-8 w-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="h-5 w-5 text-white"></i></div><div class="max-w-xs rounded-lg px-4 py-2 md:max-w-md rounded-bl-none bg-gray-700 text-slate-200"><p>Xin chào ${currentUser.name}! Tôi có thể giúp gì cho bạn hôm nay?</p></div></div></div><div class="flex items-center gap-2 border-t border-gray-700 p-4"><input id="chatbot-input" type="text" placeholder="Nhập yêu cầu..." class="flex-1 rounded-lg border-2 border-gray-600 bg-gray-700 px-4 py-2 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" /><button id="chatbot-send" class="rounded-lg bg-blue-600 p-2 text-white transition-colors hover:bg-blue-700"><i data-lucide="send" class="h-5 w-5"></i></button></div></div></div>`;
            
        const getKanbanHTML = () => `<div>${getPageHeaderHTML('Bảng công việc (Tasks)', 'Tổng hợp các task CRM và PM của toàn công ty.')}<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${['To Do', 'In Progress', 'Done'].map(status => `<div id="kanban-col-${status.toLowerCase().replace(' ', '')}" data-status="${status}" class="kanban-column flex flex-col rounded-lg bg-gray-900/70 h-[calc(100vh-230px)]"><h3 class="p-4 text-lg font-semibold text-white border-b-2 border-gray-700 flex-shrink-0">${status}</h3><div class="task-list flex-1 space-y-3 overflow-y-auto p-4"></div></div>`).join('')}</div></div>`;

        const renderKanbanTasks = () => {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const visibleTasks = currentUser.role === 'admin' ? tasksData : tasksData.filter(t => t.user && t.user.length > 0 && t.user[0].value === currentUser.username);
            
            visibleTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.id = `task-${task.id}`;
                taskEl.className = "kanban-card rounded-lg bg-gray-700 p-4 shadow-md transition-all hover:bg-gray-600/50";
                taskEl.draggable = true;
                const assignedUserEmail = task.user && task.user.length > 0 ? task.user[0].value : 'N/A';
                const assignedUser = allUsers.find(u => u.username === assignedUserEmail);
                taskEl.innerHTML = `<p class="text-slate-200">${task.Name}</p><div class="mt-2 text-xs text-slate-400"><span>Giao cho: </span><span class="font-semibold text-slate-300">${assignedUser?.name || assignedUserEmail}</span></div>`;
                
                const status = task.status ? task.status.value : 'To Do';
                const containerId = `#kanban-col-${status.toLowerCase().replace(' ', '')} .task-list`;
                const container = document.querySelector(containerId);
                if (container) container.appendChild(taskEl);
            });
        };
        
        const getCrmHTML = () => {
            const stages = [...new Set(crmData.map(d => d.stage.value))];
            return `<div>${getPageHeaderHTML('CRM Pipeline', 'Theo dõi quy trình bán hàng và các cơ hội.')}<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${stages.map(stage => `<div data-stage="${stage}" class="crm-stage flex flex-col rounded-lg bg-gray-900/70 h-[calc(100vh-230px)]"><h3 class="p-4 text-lg font-semibold text-white border-b-2 border-gray-700 flex-shrink-0">${stage}</h3><div class="crm-deal-list flex-1 space-y-3 overflow-y-auto p-4"></div></div>`).join('')}</div></div>`;
        }

        const renderCrmDeals = () => {
            const dealsByStage = crmData.reduce((acc, deal) => {
                const stage = deal.stage.value;
                if (!acc[stage]) acc[stage] = [];
                acc[stage].push(deal);
                return acc;
            }, {});

            Object.keys(dealsByStage).forEach(stage => {
                const listEl = document.querySelector(`.crm-stage[data-stage="${stage}"] .crm-deal-list`);
                if(listEl) {
                    listEl.innerHTML = dealsByStage[stage].map(deal => `
                    <div id="deal-${deal.id}" class="crm-card rounded-lg bg-gray-700 p-4 shadow-md transition-all hover:bg-gray-600/50">
                        <p class="font-semibold text-white">${deal.company}</p>
                        <p class="text-sm text-blue-400">${deal.value}</p>
                        <p class="mt-2 text-xs text-slate-400">Liên hệ: ${deal.contact}</p>
                    </div>`).join('');
                }
            });
        };
        
        const getProjectsHTML = () => `<div>${getPageHeaderHTML('Project Drive', 'Quản lý các dự án đang hoạt động.')}<div id="project-folders" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div></div>`;
        
        const renderProjectFolders = () => {
            const container = document.getElementById('project-folders');
            if (!container) return;
            const visibleProjects = currentUser.role === 'admin' ? projectsData : projectsData.filter(p => p.user && p.user.length > 0 && p.user[0].value === currentUser.username);

            container.innerHTML = visibleProjects.map(proj => `
                <div data-project-id="${proj.id}" class="project-folder-card flex flex-col items-center justify-center gap-2 p-4 rounded-lg bg-gray-800 hover:bg-blue-600 cursor-pointer transition-colors aspect-square">
                    <i data-lucide="folder-git-2" class="h-12 w-12 text-blue-400"></i>
                    <span class="font-medium text-white text-center text-sm">${proj.client && proj.client.length > 0 ? proj.client[0].value : proj.Name}</span>
                </div>`).join('');

            document.querySelectorAll('.project-folder-card').forEach(folder => {
                folder.addEventListener('click', e => {
                    const projectId = parseInt(e.currentTarget.dataset.projectId);
                    currentProjectView = projectsData.find(p => p.id === projectId);
                    renderPage();
                });
            });
            lucide.createIcons();
        };

        const getProjectDetailHTML = (project) => {
            const managerEmail = project.user && project.user.length > 0 ? project.user[0].value : 'N/A';
            const projectManager = allUsers.find(u => u.username === managerEmail);
            return `<div class="flex h-full flex-col bg-gray-800/50 rounded-lg"><div class="p-4 border-b border-gray-700 flex items-center gap-4"><button id="project-back-btn" class="p-2 rounded-md hover:bg-gray-700"><i data-lucide="arrow-left" class="h-5 w-5"></i></button><div><h2 class="text-xl font-semibold text-white">Dự án: ${project.client && project.client.length > 0 ? project.client[0].value : project.Name}</h2><p class="text-sm text-slate-400">Quản lý bởi: ${projectManager?.name || managerEmail}</p></div></div><div class="border-b border-gray-700"><nav id="project-tabs" class="flex gap-4 px-4 -mb-px"><button data-tab="documents" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-400">Tài liệu</button><button data-tab="leads" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:border-slate-300 hover:text-slate-300">Leads</button><button data-tab="ailogs" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:border-slate-300 hover:text-slate-300">AI Logs</button></nav></div><div id="project-content" class="flex-1 overflow-y-auto"></div></div>`;
        }
        
        const renderProjectDetailTabs = (project, activeTab) => {
            const contentEl = document.getElementById('project-content');
            if(!contentEl) return;
            document.querySelectorAll('#project-tabs .tab-btn').forEach(btn => {
                const isSelected = btn.dataset.tab === activeTab;
                btn.classList.toggle('border-blue-500', isSelected); btn.classList.toggle('text-blue-400', isSelected);
                btn.classList.toggle('border-transparent', !isSelected); btn.classList.toggle('text-slate-400', !isSelected);
            });
             switch(activeTab) {
                case 'documents':
                    const projectDocIds = (project.document || []).map(d => d.id);
                    const docs = documentsData.filter(d => projectDocIds.includes(d.id));
                    const getFileIcon = (type) => ({ folder: 'folder', doc: 'file-text', image: 'file-image' }[type] || 'file');
                    contentEl.innerHTML = `<table class="w-full text-left text-sm text-slate-300"><thead class="bg-gray-700/50 text-xs uppercase text-slate-400"><tr><th scope="col" class="px-6 py-3">Tên</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Ngày tạo</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Kích thước</th></tr></thead><tbody>${docs.map(file => `<tr class="border-b border-gray-700 transition-colors hover:bg-gray-700/50"><th scope="row" class="flex items-center gap-3 whitespace-nowrap px-6 py-4 font-medium text-white"><i data-lucide="${getFileIcon(file.type)}" class="h-5 w-5 text-slate-400"></i><span>${file.Name}</span></th><td class="px-6 py-4 hidden md:table-cell">${new Date(file['Created on']).toLocaleDateString()}</td><td class="px-6 py-4 hidden md:table-cell">${file.size || '—'}</td></tr>`).join('')}</tbody></table>`;
                    break;
                case 'leads':
                    const projectLeadIds = (project.lead || []).map(l => l.id);
                    const leads = leadsData.filter(l => projectLeadIds.includes(l.id));
                    contentEl.innerHTML = `<table class="w-full text-left text-sm text-slate-300"><thead class="bg-gray-700/50 text-xs uppercase text-slate-400"><tr><th scope="col" class="px-6 py-3">Nguồn</th><th scope="col" class="px-6 py-3">Tên</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Liên hệ</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Ngày</th></tr></thead><tbody>${leads.map(lead => `<tr class="border-b border-gray-700 transition-colors hover:bg-gray-700/50"><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-slate-300">${lead.source}</span></td><th scope="row" class="px-6 py-4 font-medium text-white">${lead.Name}</th><td class="px-6 py-4 hidden md:table-cell">${lead.email || lead.phone}</td><td class="px-6 py-4 hidden md:table-cell">${new Date(lead['Created on']).toLocaleDateString()}</td></tr>`).join('')} ${leads.length === 0 ? '<tr><td colspan="4" class="text-center p-6 text-slate-400">Chưa có lead nào cho dự án này.</td></tr>' : ''}</tbody></table>`;
                    break;
                case 'ailogs':
                    const projectLogIds = (project.logs || []).map(l => l.id);
                    const logs = logsData.filter(l => projectLogIds.includes(l.id));
                    contentEl.innerHTML = `<div class="p-4 space-y-4">${logs.map(log => `<div class="flex items-start gap-3"><div class="mt-1"><i data-lucide="terminal" class="h-4 w-4 text-green-400"></i></div><div><p class="text-sm text-slate-300">${log.action}</p><p class="text-xs text-slate-500">${new Date(log['Created on']).toLocaleString()}</p></div></div>`).join('')} ${logs.length === 0 ? '<div class="text-center p-6 text-slate-400">Không có hoạt động tự động nào được ghi nhận.</div>' : ''}</div>`;
                    break;
            }
            lucide.createIcons();
        };

        const getLeadsHTML = () => `<div>${getPageHeaderHTML('Danh sách Leads', 'Tổng hợp leads thu về từ các dự án.')}<div id="leads-container" class="flex-1 space-y-6 overflow-y-auto"></div></div>`;
        
        const renderLeadsByProject = () => {
             const container = document.getElementById('leads-container');
             if(!container) return;
             const visibleProjects = currentUser.role === 'admin' ? projectsData : projectsData.filter(p => p.user && p.user.length > 0 && p.user[0].value === currentUser.username);
             container.innerHTML = visibleProjects.map(project => {
                 const projectLeadIds = (project.lead || []).map(l => l.id);
                 const leads = leadsData.filter(l => projectLeadIds.includes(l.id));
                 return `<div class="bg-gray-800/50 rounded-lg"><h3 class="p-4 text-lg font-semibold text-white border-b border-gray-700">${project.client && project.client.length > 0 ? project.client[0].value : project.Name}</h3><div class="p-4">${leads.length > 0 ? `<ul class="space-y-3">${leads.map(lead => `<li class="flex justify-between items-center p-3 rounded-md bg-gray-700/50"><div><p class="font-medium text-white">${lead.Name}</p><p class="text-sm text-slate-400">${lead.email || lead.phone}</p></div><div class="text-right"><span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-slate-300">${lead.source}</span><p class="text-xs text-slate-500 mt-1">${new Date(lead['Created on']).toLocaleDateString()}</p></div></li>`).join('')}</ul>` : '<p class="text-slate-400 text-center">Không có leads cho dự án này.</p>'}</div></div>`
             }).join('');
        };
        
        //=========== EVENT HANDLERS ===========//
        const handleLogin = async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            const email = usernameInput.value;
            const password = passwordInput.value;
            
            try {
                const users = await fetchBaserowTable(849); // User table
                if (users.length === 0) { // Check if user fetch failed
                     throw new Error('Không thể tải danh sách người dùng.');
                }
                
                const foundUser = users.find(user => user.email === email && user.pass === password);

                if (foundUser) {
                    currentUser = {
                        username: foundUser.email,
                        name: foundUser.email.split('@')[0],
                        role: foundUser.role.value
                    };
                    allUsers = users.map(u => ({ username: u.email, name: u.email.split('@')[0], role: u.role.value }));
                    chatbotThreadId = crypto.randomUUID(); // Tạo thread ID duy nhất cho phiên chat
                    
                    loginPage.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    
                    userNameDisplay.textContent = currentUser.name;
                    userRoleDisplay.textContent = currentUser.role === 'admin' ? 'Quản trị viên' : 'Nhân viên';
                    userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
                    
                    await loadDashboardData(); // Load all other data after successful login
                } else {
                    throw new Error('Email hoặc mật khẩu không đúng.');
                }
            } catch (error) {
                console.error('Lỗi đăng nhập:', error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                loginButtonText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        };
        
        const handleLogout = () => {
            currentUser = null; allUsers = [];
            chatbotThreadId = null; // Reset thread ID khi logout
            crmData = [], projectsData = [], documentsData = [], tasksData = [], leadsData = [], logsData = [];
            loginPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.classList.add('hidden');
        };
        
        const addKanbanEventListeners = () => { /* Drag-and-drop logic can be added here */ };
        
        const addChatbotEventListeners = () => { 
            const sendBtn = document.getElementById('chatbot-send');
            const input = document.getElementById('chatbot-input');
            const messagesContainer = document.getElementById('chatbot-messages');
            if(!sendBtn) return;

            const sendMessage = async () => {
                const text = input.value.trim();
                if (text === '') return;

                // 1. Hiển thị tin nhắn của người dùng
                messagesContainer.innerHTML += `<div class="flex items-end gap-2 justify-end"><div class="max-w-xs rounded-lg px-4 py-2 md:max-w-md rounded-br-none bg-blue-600 text-white"><p>${text}</p></div></div>`;
                input.value = '';
                input.disabled = true;
                sendBtn.disabled = true;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // 2. Hiển thị chỉ báo "bot đang gõ"
                const typingIndicatorId = `typing-${Date.now()}`;
                messagesContainer.innerHTML += `
                    <div id="${typingIndicatorId}" class="flex items-end gap-2 justify-start">
                        <div class="h-8 w-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="h-5 w-5 text-white"></i></div>
                        <div class="max-w-xs rounded-lg px-4 py-2 md:max-w-md rounded-bl-none bg-gray-700 text-slate-200">
                           <div class="flex items-center gap-1">
                                <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                                <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                                <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce"></span>
                           </div>
                        </div>
                    </div>`;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                lucide.createIcons();

                // 3. Gọi webhook
                try {
                    const webhookUrl = 'https://aps.aibm.space/webhook/perform1';
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            task: 'chatbot',
                            prompt: text,
                            threadid: chatbotThreadId
                        })
                    });

                    if (!response.ok) throw new Error(`Lỗi Webhook: ${response.statusText}`);

                    const result = await response.json();
                    const botReply = result[0]?.output || "Xin lỗi, tôi không thể xử lý yêu cầu này.";

                    // 4. Thay thế chỉ báo "đang gõ" bằng câu trả lời của bot
                    const typingIndicator = document.getElementById(typingIndicatorId);
                    if (typingIndicator) {
                        typingIndicator.innerHTML = `
                            <div class="h-8 w-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="h-5 w-5 text-white"></i></div>
                            <div class="max-w-xs rounded-lg px-4 py-2 md:max-w-md rounded-bl-none bg-gray-700 text-slate-200">
                                <p>${botReply}</p>
                            </div>`;
                        lucide.createIcons();
                    }
                } catch (error) {
                    console.error('Lỗi khi gọi chatbot webhook:', error);
                    const typingIndicator = document.getElementById(typingIndicatorId);
                    if(typingIndicator) {
                        typingIndicator.innerHTML = `
                            <div class="h-8 w-8 rounded-full bg-red-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="alert-triangle" class="h-5 w-5 text-white"></i></div>
                            <div class="max-w-xs rounded-lg px-4 py-2 md:max-w-md rounded-bl-none bg-gray-700 text-slate-200">
                                <p>Đã có lỗi xảy ra. Vui lòng thử lại.</p>
                            </div>`;
                        lucide.createIcons();
                    }
                } finally {
                    input.disabled = false;
                    sendBtn.disabled = false;
                    input.focus();
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            };

            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        };
        
        const addProjectDetailEventListeners = (project) => { 
            document.getElementById('project-back-btn')?.addEventListener('click', () => {
                currentProjectView = null; renderPage();
            });
            document.querySelectorAll('#project-tabs .tab-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    renderProjectDetailTabs(project, e.currentTarget.dataset.tab);
                });
            });
        };

        //=========== INITIALIZATION ===========//
        const init = () => {
            document.getElementById('login-icon-container').innerHTML = `<i data-lucide="building-2" class="h-12 w-12"></i>`;
            lucide.createIcons();
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            sidebarToggleDesktop.addEventListener('click', toggleSidebar);
            sidebarToggleMobile.addEventListener('click', toggleSidebar);
            window.addEventListener('resize', () => {
                isSidebarCollapsed = window.innerWidth < 1024;
                applySidebarState();
            });
            applySidebarState();
        };

        init();
    });
    </script>
</body>
</html>

